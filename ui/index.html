<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Churn Intelligence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f4f5;
      --card-bg:#ffffff;
      --text-primary:#111827;
      --text-secondary:#6b7280;
      --border:#e5e7eb;
      --loader:#9ca3af;
      --shadow:0 10px 25px rgba(0,0,0,0.05);
    }

    *{
      box-sizing:border-box;
      font-family:'Open Sans', sans-serif;
      font-weight:300;
    }

    body{
      margin:0;
      min-height:100vh;
      background:var(--bg);
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--text-primary);
    }

    .wrap{
      width:760px;
      max-width:92%;
    }

    .card{
      background:var(--card-bg);
      border:1px solid var(--border);
      border-radius:14px;
      padding:45px;
      box-shadow:var(--shadow);
    }

    h1{
      text-align:center;
      font-weight:300;
      margin:0 0 6px;
      background:linear-gradient(90deg,#555,#999);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }

    .subtitle{
      text-align:center;
      color:#8a8a8a;
      margin:0 0 28px;
      font-size:14px;
      line-height:1.6;
    }

    .notice{
      border:1px solid var(--border);
      background:#fafafa;
      border-radius:12px;
      padding:14px 14px;
      margin:0 0 22px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }

    .notice .dot{
      width:10px;
      height:10px;
      border-radius:999px;
      margin-top:5px;
      background:#9ca3af;
      flex:0 0 auto;
    }

    .notice .text{
      color:#6b7280;
      font-size:13px;
      line-height:1.6;
    }

    .health{
      margin-top:8px;
      font-size:12px;
      color:#9ca3af;
    }

    .loader-row{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      margin-top:10px;
    }

    .loader{
      width:16px;
      height:16px;
      border:2px solid var(--border);
      border-top:2px solid var(--loader);
      border-radius:50%;
      animation:spin 1s linear infinite;
    }

    @keyframes spin{
      to{ transform:rotate(360deg); }
    }

    .form-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:18px;
      opacity:1;
      transition:opacity .2s ease;
    }

    .full{
      grid-column:span 2;
    }

    input, select{
      width:100%;
      padding:12px;
      border-radius:8px;
      border:1px solid #e2e2e2;
      background:#fbfbfb;
      transition:0.2s;
      color:var(--text-primary);
    }

    input:focus, select:focus{
      outline:none;
      border-color:#cfcfcf;
      background:white;
    }

    button{
      padding:14px;
      border:none;
      border-radius:9px;
      background:#2b2b2b;
      color:white;
      font-weight:300;
      letter-spacing:0.5px;
      cursor:pointer;
      transition:0.25s;
      box-shadow:0 6px 18px rgba(0,0,0,0.08);
    }

    button:hover{
      background:#1f1f1f;
    }

    button:disabled{
      cursor:not-allowed;
      opacity:.55;
      box-shadow:none;
    }

    .result{
      margin-top:28px;
      padding:28px;
      border-radius:12px;
      background:#fafafa;
      box-shadow:0 8px 25px rgba(0,0,0,0.05);
      display:none;
    }

    .badge{
      text-align:center;
      padding:16px;
      border-radius:10px;
      font-size:18px;
      letter-spacing:0.5px;
      margin-bottom:18px;
      color:#111827;
    }

    .low{ background:#f1f1f1; }
    .mild{ background:#e4e4e4; }
    .high{ background:#d6d6d6; }

    .bar{
      height:12px;
      background:#e8e8e8;
      border-radius:8px;
      overflow:hidden;
    }

    .progress{
      height:100%;
      width:0%;
      background:#7a7a7a;
      transition:width 0.6s ease;
    }

    .prob{
      text-align:center;
      margin-top:12px;
      color:#666;
      font-size:14px;
    }

    .spinner{
      display:none;
      text-align:center;
      margin-top:18px;
      color:#777;
      font-size:13px;
    }

    .error{
      display:none;
      margin-top:16px;
      padding:14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fcfcfc;
      color:#6b7280;
      font-size:13px;
      line-height:1.6;
    }

    .muted{
      color:#9ca3af;
      font-size:12px;
      text-align:center;
      margin-top:18px;
    }

    @media(max-width:820px){
      .card{ padding:30px; }
      .form-grid{ grid-template-columns:1fr; }
      .full{ grid-column:span 1; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>Churn Intelligence</h1>
      <div class="subtitle">
        Predict customer churn risk with machine learning
      </div>

      <div class="notice">
        <div class="dot"></div>
        <div class="text">
          The application is hosted on Render and may take <b>50–60 seconds</b> to activate.
          This page checks the service health and enables prediction as soon as the backend is ready.
          <div class="health" id="healthText">Checking service health…</div>
          <div class="loader-row" id="healthLoaderRow">
            <div class="loader"></div>
            <div class="health">Waiting for <span id="healthUrlText"></span></div>
          </div>
        </div>
      </div>

      <form id="form" class="form-grid">
        <input id="tenure" type="number" placeholder="Tenure Months" required>
        <input id="session" type="number" step="0.1" placeholder="Avg Session Duration" required>

        <input id="sessions" type="number" placeholder="Sessions Last 30 Days" required>
        <input id="usage" type="number" step="0.01" placeholder="Feature Usage Score (0–1)" required>

        <input id="tickets" type="number" placeholder="Support Tickets" required>
        <input id="login" type="number" placeholder="Last Login Days Ago" required>

        <input id="spend" type="number" step="0.01" placeholder="Monthly Spend USD" required>
        <input id="failures" type="number" placeholder="Payment Failures" required>

        <select id="plan">
          <option value="free">Free Plan</option>
          <option value="basic">Basic</option>
          <option value="pro">Pro</option>
          <option value="enterprise">Enterprise</option>
        </select>

        <select id="region">
          <option value="NA">North America</option>
          <option value="EU">Europe</option>
          <option value="APAC">APAC</option>
          <option value="LATAM">LATAM</option>
        </select>

        <select id="annual" class="full">
          <option value="1">Annual Plan</option>
          <option value="0">Monthly Plan</option>
        </select>

        <button class="full" id="submitBtn" type="submit" disabled>
          Warming up backend…
        </button>
      </form>

      <div class="spinner" id="spinner">Running prediction…</div>

      <div class="error" id="errorBox"></div>

      <div class="result" id="result">
        <div id="badge" class="badge"></div>
        <div class="bar">
          <div id="progress" class="progress"></div>
        </div>
        <div class="prob">
          Probability: <b id="prob"></b>
        </div>
      </div>

      <div class="muted">
        Keep this tab open. Prediction will start immediately once the service responds.
      </div>
    </div>
  </div>

  <script>
    const RENDER_APP_URL = "https://churn-predictor-ful0.onrender.com";
    const HEALTH_ENDPOINT = `${RENDER_APP_URL}/`;
    const PREDICT_ENDPOINT = `${RENDER_APP_URL}/predict`;
    const UI_ENDPOINT = `${RENDER_APP_URL}/ui`;
    const POLL_INTERVAL_MS = 3000;

    const form = document.getElementById("form");
    const submitBtn = document.getElementById("submitBtn");
    const spinner = document.getElementById("spinner");
    const result = document.getElementById("result");
    const errorBox = document.getElementById("errorBox");

    const healthText = document.getElementById("healthText");
    const healthLoaderRow = document.getElementById("healthLoaderRow");
    const healthUrlText = document.getElementById("healthUrlText");
    healthUrlText.textContent = HEALTH_ENDPOINT;

    let backendReady = false;
    let pollHandle = null;

    function setBackendReady() {
      backendReady = true;
      if (pollHandle) clearInterval(pollHandle);

      healthText.textContent = "Service is ready. You can run predictions now.";
      healthLoaderRow.style.display = "none";

      submitBtn.disabled = false;
      submitBtn.textContent = "Predict Risk";
    }

    function setBackendWarming(attempt) {
      submitBtn.disabled = true;
      submitBtn.textContent = `Warming up backend…)`;
      healthText.textContent = "Waiting for the backend to wake up…";
      healthLoaderRow.style.display = "flex";
    }

    async function checkHealth(attempt) {
      try {
        const res = await fetch(HEALTH_ENDPOINT, { cache: "no-store" });
        if (res.ok) {
          setBackendReady();
        } else {
          setBackendWarming(attempt);
        }
      } catch (_) {
        setBackendWarming(attempt);
      }
    }

    (function startHealthPolling() {
      let attempt = 1;
      checkHealth(attempt);
      pollHandle = setInterval(() => {
        attempt += 1;
        checkHealth(attempt);
      }, POLL_INTERVAL_MS);
    })();

    function showError(message) {
      errorBox.style.display = "block";
      errorBox.textContent = message;
    }

    function clearError() {
      errorBox.style.display = "none";
      errorBox.textContent = "";
    }

    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      clearError();

      if (!backendReady) {
        showError("Backend is still warming up. Please wait a few seconds and try again.");
        return;
      }

      spinner.style.display = "block";
      result.style.display = "none";

      const tenure = document.getElementById("tenure");
      const session = document.getElementById("session");
      const sessions = document.getElementById("sessions");
      const usage = document.getElementById("usage");
      const tickets = document.getElementById("tickets");
      const login = document.getElementById("login");
      const spend = document.getElementById("spend");
      const failures = document.getElementById("failures");
      const plan = document.getElementById("plan");
      const region = document.getElementById("region");
      const annual = document.getElementById("annual");

      const payload = {
        tenure_months: parseInt(tenure.value, 10),
        avg_session_duration: parseFloat(session.value),
        sessions_last_30_days: parseInt(sessions.value, 10),
        feature_usage_score: parseFloat(usage.value),
        support_tickets_last_90_days: parseInt(tickets.value, 10),
        last_login_days_ago: parseInt(login.value, 10),
        monthly_spend_usd: parseFloat(spend.value),
        payment_failures_last_6m: parseInt(failures.value, 10),
        plan_type: plan.value,
        region: region.value,
        is_annual_plan: parseInt(annual.value, 10)
      };

      try {
        const res = await fetch(PREDICT_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error(`Prediction failed (HTTP ${res.status}).`);
        }

        const data = await res.json();

        spinner.style.display = "none";
        result.style.display = "block";

        const probability = data.churn_probability;
        const percent = (probability * 100).toFixed(1);

        document.getElementById("prob").innerText = `${percent}%`;
        document.getElementById("progress").style.width = `${percent}%`;

        const badge = document.getElementById("badge");

        if (probability < 0.35) {
          badge.className = "badge low";
          badge.innerText = "LOW CHURN RISK";
        } else if (probability < 0.65) {
          badge.className = "badge mild";
          badge.innerText = "MILD CHURN RISK";
        } else {
          badge.className = "badge high";
          badge.innerText = "HIGH CHURN RISK";
        }
      } catch (err) {
        spinner.style.display = "none";
        showError(
          "Unable to reach the prediction service. " +
          "If this is the first request, Render may still be waking up. " +
          "Please wait a few seconds and try again.\n\n" +
          `Details: ${err && err.message ? err.message : "Unknown error"}`
        );
      }
    });
  </script>
</body>
</html>
